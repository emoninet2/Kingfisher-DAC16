/*
 * DACx1416.c
 *
 *  Created on: Oct 18, 2024
 *      Author: habiburrahman
 */
#include "main.h"
#include "DACx1416.h"




extern SPI_HandleTypeDef hspi1;

void SPI1_TransmitReceive(uint8_t *txBuffer, uint8_t *rxBuffer, uint16_t size)
{
    // Pull CS low to start the transmission
    HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, GPIO_PIN_RESET); // Set CS low (adjust GPIO pin as needed)

    // Full-duplex transmission and reception (blocking mode)
    if (HAL_SPI_TransmitReceive(&hspi1, txBuffer, rxBuffer, size, HAL_MAX_DELAY) != HAL_OK)
    {
        // Communication error
        Error_Handler();
    }

    // Pull CS high to end the transmission
    HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, GPIO_PIN_SET);   // Set CS high (adjust GPIO pin as needed)
}


void DACx1416_SPI_transmit(uint8_t *txBuffer,uint16_t size){



	// Full-duplex transmission and reception (blocking mode)
	if (HAL_SPI_Transmit(&hspi1, txBuffer, size, HAL_MAX_DELAY) != HAL_OK)
	{
		// Communication error
		Error_Handler();
	}



}


void DACx1416_SPI_receive(uint8_t *rxBuffer,uint16_t size){


	// Full-duplex transmission and reception (blocking mode)
	if (HAL_SPI_Receive(&hspi1, rxBuffer, size, HAL_MAX_DELAY) != HAL_OK)
	{
		// Communication error
		Error_Handler();
	}

}


void DACx1416_SPI_transmitReceive(uint8_t *txBuffer, uint8_t *rxBuffer, uint16_t size){


    // Full-duplex transmission and reception (blocking mode)
    if (HAL_SPI_TransmitReceive(&hspi1, txBuffer, rxBuffer, size, HAL_MAX_DELAY) != HAL_OK)
    {
        // Communication error
        Error_Handler();
    }

}




void DACx1416_write_register_old(uint8_t address, uint16_t data){
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, GPIO_PIN_RESET); // Set CS low (adjust GPIO pin as needed)
	uint8_t txBuffer[3] = {address & ~(1<<7) , (data >> 8) & 0xFF, data & 0xFF};
	uint8_t rxBuffer[3];
	SPI1_TransmitReceive(txBuffer, rxBuffer,  3);
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, GPIO_PIN_SET);   // Set CS high (adjust GPIO pin as needed)
}

uint16_t DACx1416_read_register_old(uint8_t address){
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, GPIO_PIN_RESET); // Set CS low (adjust GPIO pin as needed)
	uint8_t txBuffer[3] = {address | (1<<7) , 0xFF, 0xFF};
	uint8_t rxBuffer[3];
	DACx1416_SPI_transmit(txBuffer, 3);
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, GPIO_PIN_SET);   // Set CS high (adjust GPIO pin as needed)

	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, GPIO_PIN_RESET); // Set CS low (adjust GPIO pin as needed)
	DACx1416_SPI_receive(rxBuffer, 3);
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, GPIO_PIN_SET);   // Set CS high (adjust GPIO pin as needed)

	return rxBuffer[1]<<8 | rxBuffer[2];

}




void DACx1416_write_register(DACx1416_HandleTypeDef dac, DACx1416_register_t reg, uint16_t data){
	uint8_t txBuffer[3] = {reg & ~(1<<7) , (data >> 8) & 0xFF, data & 0xFF};
	uint8_t rxBuffer[3];
	dac.nCS(0);
	dac.SPI_transmitReceive(txBuffer, rxBuffer, 3);
	dac.nCS(1);

}
uint16_t DACx1416_read_register(DACx1416_HandleTypeDef dac, DACx1416_register_t reg){
	uint8_t txBuffer[3] = {reg | (1<<7) , 0xFF, 0xFF};
	uint8_t rxBuffer[3];
	dac.nCS(0);
	dac.SPI_transmitReceive(txBuffer, rxBuffer, 3);
	dac.nCS(1);
	dac.nCS(0);
	dac.SPI_receive(rxBuffer, 3);
	dac.nCS(1);
	return rxBuffer[1]<<8 | rxBuffer[2];
}


DACx1416_deviceID_t get_device_id(DACx1416_HandleTypeDef DACx1416){
	DACx1416_deviceID_t deviceID;
	uint16_t deviceIdVal = DACx1416_read_register(DACx1416,DACx1416_REG_DEVICEID);
	deviceID.deviceId = (deviceIdVal>>2) & 0x3FFF;
	deviceID.versionId = deviceIdVal & 0x0003;
	return deviceID;
}
